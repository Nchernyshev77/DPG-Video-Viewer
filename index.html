<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DPG VR Video Viewer</title>
<link rel="icon" href="data:,">
<meta name="referrer" content="no-referrer">
<style>
:root { color-scheme: dark light; }
html, body { margin:0; padding:0; height:100%; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; }
#viewer { position:fixed; inset:0; background:#000; overflow:hidden; }
#toolbar { position:fixed; top:8px; left:8px; right:8px; display:flex; gap:.5rem; align-items:center; z-index:10 }
.btn { appearance:none; border:1px solid #2c2f36; border-radius:8px; background:#0e0f13; color:#e6e7ea; padding:.45rem .7rem; cursor:pointer; }
.btn:disabled{ opacity:.5; cursor:not-allowed }

#introBackdrop{ position:fixed; inset:0; background:#000c; display:none; z-index:9 }
#status{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); padding:14px 16px; background:#0e0f13; color:#e6e7ea; border:1px solid #2c2f36; border-radius:12px; display:none; z-index:11; min-width:260px; text-align:center }
#status.show{ display:block }
#introBackdrop.show{ display:block }
#status progress{ width:100% }

/* Shared modal look */
#appLinkModal, #downloadModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10000; }
.modal-backdrop{ position:absolute; inset:0; background:#000C; backdrop-filter: blur(2px); }
.modal-card{ position:relative; background:#0e0f13; color:#e6e7ea; border:1px solid #2c2f36; border-radius:12px; padding:12px 14px; width:min(480px, 92vw); box-shadow:0 10px 30px #000a; font-family:inherit; }
.modal-title{ margin:0 0 8px 0; font-weight:600; font-size:15px; color:#f1f2f4; }
.modal-row{ display:flex; gap:.5rem; align-items:center; }
.modal-input{ flex:1; background:#181a1f; color:#fff; border:1px solid #343842; border-radius:8px; padding:.55rem .65rem; font-size:13px; }
.modal-btn{ border:1px solid #2c2f36; background:#0e0f13; color:#e6e7ea; border-radius:8px; padding:.5rem .7rem; cursor:pointer; }
.modal-btn:active{ transform:translateY(1px); }
.modal-footer{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-top:8px; }
.modal-muted{ opacity:.75; font-size:11px; }
.copy-icon{ display:inline-flex; align-items:center; justify-content:center; border:1px solid #343842; background:#15171c; color:#fff; border-radius:8px; padding:.5rem .6rem; cursor:pointer; }
.copy-icon svg{ width:16px; height:16px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div id="viewer"></div>

<div id="toolbar">
  <label class="btn">Open
    <input id="file" type="file" accept="video/*" multiple style="display:none">
  </label>
  <button id="uploadAndLinkBtn" class="btn">Upload and Link</button>
  <span style="flex:1"></span>
  <button id="signInBtn" class="btn" title="Authorize Google Drive (one-time)">Sign in with Google</button>
</div>

<div id="introBackdrop"></div>
<div id="status">
  <div id="statusText" style="margin-bottom:.5rem">Working…</div>
  <progress id="progress" value="0" max="1"></progress>
</div>

<!-- Copy Link modal -->
<div id="appLinkModal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <h3 class="modal-title">Copy Link</h3>
    <div class="modal-row">
      <input id="appLinkField" class="modal-input" readonly>
      <button id="copyAppLink" class="copy-icon" title="Copy link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>
    <div class="modal-footer">
      <span class="modal-muted">The link is copied automatically. Use the icon to copy again.</span>
      <button id="appLinkClose" class="modal-btn">Close</button>
    </div>
  </div>
</div>

<!-- Download gate modal -->
<div id="downloadModal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-card">
    <h3 class="modal-title">Download Video</h3>
    <div class="modal-row" style="margin-top:2px;">
      <span class="modal-muted">Sign in to your Google account to download and play this video.</span>
    </div>
    <div class="modal-footer">
      <span class="modal-muted" id="dlStatus"></span>
      <button id="downloadConfirm" class="modal-btn">Download Video</button>
    </div>
  </div>
</div>

<script>
// --- Minimal player glue ---
let videoEl = null;
function ensureVideo(){
  if (!videoEl){
    videoEl = document.createElement('video');
    videoEl.controls = true;
    videoEl.playsInline = true;
    videoEl.style.position='absolute';
    videoEl.style.inset='0';
    videoEl.style.width='100%';
    videoEl.style.height='100%';
    videoEl.style.objectFit='contain';
    document.getElementById('viewer').appendChild(videoEl);
  }
  return videoEl;
}
function loadURL(url, label='remote', {autoplay=false}={}){
  const v = ensureVideo();
  v.src = url;
  if (autoplay) v.play().catch(()=>{});
}
</script>

<script type="module">
// === Config (your constants) ===
const DRIVE_GOOGLE_CLIENT_ID = '1053048724849-jaoe9s17j4okh8esuf7ffd2lqijluat8.apps.googleusercontent.com';
const DRIVE_FOLDER_ID        = '1zkzCbXzRoUZP7Ps1ozV3U3Mkh7GOqR1t';
const DRIVE_DOMAINS          = ['dpg.email','aktd.email'];

// OAuth (GIS)
let driveAccessToken = null;
let driveTokenClient = null;

function initAuth(){
  if (!window.google || !google.accounts || !google.accounts.oauth2) return;
  driveTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: DRIVE_GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive',
    callback: (resp)=>{
      if (resp && resp.access_token){
        driveAccessToken = resp.access_token;
        localStorage.setItem('drive_oauth_granted','1');
      }
    }
  });
}
window.addEventListener('load', initAuth);

// Silent refresh on load if previously granted
window.addEventListener('load', async ()=>{
  try{
    if (localStorage.getItem('drive_oauth_granted') === '1'){
      if (!driveTokenClient) initAuth();
      if (driveTokenClient){
        await new Promise((resolve, reject)=>{
          try{
            driveTokenClient.callback = (resp)=>{
              if (resp && resp.access_token){ driveAccessToken = resp.access_token; resolve(); }
              else reject(new Error('no_access_token'));
            };
            driveTokenClient.requestAccessToken({ prompt: '' });
          }catch(e){ reject(e); }
        });
      }
    }
  }catch(_){}
});

function requestToken(options={}){
  return new Promise((resolve, reject)=>{
    if (!driveTokenClient){ initAuth(); }
    if (!driveTokenClient){ reject(new Error('oauth_lib_not_loaded')); return; }
    driveTokenClient.callback = (resp)=>{
      if (resp && resp.access_token){ driveAccessToken = resp.access_token; localStorage.setItem('drive_oauth_granted','1'); resolve(driveAccessToken); }
      else reject(new Error((resp && (resp.error_description || resp.error)) || 'no_access_token'));
    };
    driveTokenClient.requestAccessToken(options);
  });
}

async function ensureToken({interactive=false}={}){
  if (driveAccessToken) return driveAccessToken;
  if (localStorage.getItem('drive_oauth_granted') === '1'){
    try { await requestToken({ prompt: '' }); if (driveAccessToken) return driveAccessToken; } catch(_){}
  }
  if (interactive){
    await requestToken({ prompt: 'consent' });
    return driveAccessToken;
  }
  throw new Error('needs_user_gesture');
}

// Sign-in button (one-time)
document.getElementById('signInBtn').addEventListener('click', async ()=>{
  try{
    await ensureToken({interactive:true});
    alert('Access granted. You will not see the consent again on this browser.');
  }catch(e){
    alert((e && e.message) || String(e));
  }
});

// File selection helpers
const input = document.getElementById('file');
input.addEventListener('change', e => {
  const files = Array.from(e.target.files || []);
  if (!files.length) return;
  const f = files[0];
  window.__lastSelectedFile = f;
  const url = URL.createObjectURL(f);
  loadURL(url, f.name, {autoplay:true});
  e.target.value='';
});

document.addEventListener('dragover', e=> e.preventDefault());
document.addEventListener('drop', e=>{
  e.preventDefault();
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
    const f = e.dataTransfer.files[0];
    window.__lastSelectedFile = f;
    const url = URL.createObjectURL(f);
    loadURL(url, f.name, {autoplay:true});
  }
});

async function getCurrentFile(){
  if (window.__lastSelectedFile) return window.__lastSelectedFile;
  try{
    const v = document.querySelector('video');
    const src = v && (v.currentSrc || v.src);
    if (src && /^blob:/i.test(src)){
      const b = await fetch(src).then(r=>r.blob());
      try{ return new File([b],'video_from_player',{type:b.type}); }catch(_){ return b; }
    }
  }catch(_){}
  return null;
}

// Drive resumable
async function createResumableSession(f){
  const init = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable&supportsAllDrives=true', {
    method: 'POST',
    headers: {
      Authorization: 'Bearer ' + driveAccessToken,
      'Content-Type': 'application/json; charset=UTF-8',
      'X-Upload-Content-Type': (f.type || 'application/octet-stream'),
      'X-Upload-Content-Length': String(f.size)
    },
    body: JSON.stringify({ name: (f.name||'video'), parents: [DRIVE_FOLDER_ID] })
  });
  if (!init.ok) {
    const t = await init.text().catch(()=>'');
    throw new Error('init_fail '+init.status+' '+t);
  }
  const sessionUrl = init.headers.get('Location');
  if (!sessionUrl) throw new Error('no_upload_session_location');
  return sessionUrl;
}
async function uploadChunks(sessionUrl, f, onProgress){
  const chunkSize = 8 * 1024 * 1024;
  let offset = 0;
  while (offset < f.size){
    const end = Math.min(offset + chunkSize, f.size);
    if (!(Number.isFinite(offset) && Number.isFinite(end) && offset >= 0 && end > offset))
      throw new Error('range_calc_error ' + offset + '-' + end + '/' + f.size);
    const chunk = f.slice(offset, end);
    const res = await fetch(sessionUrl, {
      method: 'PUT',
      headers: {
        'Content-Type': (f.type || 'application/octet-stream'),
        'Content-Length': String(chunk.size),
        'Content-Range': `bytes ${offset}-${end-1}/${f.size}`
      },
      body: chunk
    });
    if (res.status === 308){
      const rng = res.headers.get('Range');
      if (rng){
        const m = rng.match(/(\\d+)-(\\d+)$/);
        offset = m ? (parseInt(m[2],10) + 1) : end;
      } else offset = end;
      if (onProgress) onProgress(offset, f.size);
      continue;
    }
    if (!res.ok){
      const t = await res.text().catch(()=>'');
      throw new Error('chunk_fail ' + res.status + ' ' + t);
    }
    const data = await res.json();
    return data;
  }
  throw new Error('unexpected_end');
}

// Copy Link modal
function showAppLinkModal(appLink){
  const modal = document.getElementById('appLinkModal');
  const input = document.getElementById('appLinkField');
  const copy  = document.getElementById('copyAppLink');
  const close = document.getElementById('appLinkClose');
  if (input) input.value = appLink;
  modal.style.display='flex';
  modal.setAttribute('aria-hidden','false');
  document.documentElement.style.overflow='hidden';
  // copy best-effort
  (async () => {
    try { await navigator.clipboard.writeText(appLink); }
    catch(_){ try{ if (input){ input.select(); document.execCommand('copy'); } }catch(__){} }
  })();
  copy.onclick = ()=>{ try{ navigator.clipboard.writeText(appLink); }catch(_){ try{ input.select(); document.execCommand('copy'); }catch(__){} } };
  const hide = ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; };
  close.onclick = hide;
  modal.querySelector('.modal-backdrop').onclick = hide;
}

// Upload and Link
document.getElementById('uploadAndLinkBtn').addEventListener('click', async (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  try{
    const f = await getCurrentFile();
    if (!f) { alert('Add a local video first.'); return; }
    await ensureToken({interactive:true});

    const status = document.getElementById('status');
    const intro  = document.getElementById('introBackdrop');
    const prog   = document.getElementById('progress');
    const stxt   = document.getElementById('statusText');
    status.classList.add('show'); intro.classList.add('show');
    if (stxt) stxt.textContent='Uploading to Drive…'; if (prog){ prog.value=0; prog.max=1; }

    const session = await createResumableSession(f);
    const info = await uploadChunks(session, f, (done,total)=>{ try{ if (prog) prog.value = total ? (done/total) : 0; }catch(_){}});

    status.classList.remove('show'); intro.classList.remove('show');

    const fileId = info && info.id; if (!fileId) throw new Error('no_file_id');

    // set permissions in background (non-blocking)
    try{
      for (const dom of DRIVE_DOMAINS){
        fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/permissions?supportsAllDrives=true`, {
          method:'POST', headers:{ Authorization:'Bearer '+driveAccessToken, 'Content-Type':'application/json' },
          body: JSON.stringify({ type:'domain', role:'reader', domain: dom, allowFileDiscovery:false })
        }).catch(()=>{});
      }
    }catch(_){}

    const appLink = location.origin + location.pathname + '?id=' + encodeURIComponent(fileId);
    showAppLinkModal(appLink);
  }catch(e){
    alert((e && e.message) || String(e));
  }
});

// Open by ?id
(async function(){
  const id = new URLSearchParams(location.search).get('id');
  if (!id) return;

  async function fetchDriveFileToBlob(fileId){
    const url = `https://www.googleapis.com/drive/v3/files/${encodeURIComponent(fileId)}?alt=media&supportsAllDrives=true`;
    const r = await fetch(url, { headers:{ Authorization:'Bearer '+driveAccessToken } });
    if (!r.ok){
      let msg = 'Drive fetch failed: ' + r.status;
      try{ const j = await r.json(); if (j && j.error && j.error.message) msg += ' — ' + j.error.message; }catch(_){};
      throw new Error(msg);
    }
    return await r.blob();
  }

  // Try silent
  try{
    await ensureToken(); // prompt: ''
    if (!driveAccessToken) throw new Error('needs_user_gesture');
    const blob = await fetchDriveFileToBlob(id);
    const url = URL.createObjectURL(blob);
    loadURL(url, 'drive:'+id, {autoplay:false});
  }catch(_){
    // Show Download Video modal
    const modal = document.getElementById('downloadModal');
    const btn   = document.getElementById('downloadConfirm');
    const stat  = document.getElementById('dlStatus');
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden';
    btn.onclick = async ()=>{
      try{
        stat.textContent='Sign-in…';
        await ensureToken({interactive:true});
        stat.textContent='Downloading…';
        const blob = await fetchDriveFileToBlob(id);
        const url = URL.createObjectURL(blob);
        loadURL(url, 'drive:'+id, {autoplay:false});
        stat.textContent='';
        modal.style.display='none'; modal.setAttribute('aria-hidden','true');
        document.documentElement.style.overflow='';
      }catch(e){
        stat.textContent = (e && e.message) || String(e);
      }
    };
    modal.querySelector('.modal-backdrop').onclick = ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; };
  }
})();
</script>
</body>
</html>
